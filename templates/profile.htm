<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Account - Caro Game</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      .avatar-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .avatar-item {
        position: relative;
        width: 100px;
        height: 100px;
        border: 2px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .avatar-item.active {
        border-color: #4caf50;
      }

      .avatar-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .avatar-item input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .avatar-item:hover {
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .avatar-item::after {
        content: "";
        position: absolute;
        right: 5px;
        bottom: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #ddd;
        display: none;
      }

      .avatar-item.active::after {
        display: block;
        background-color: #4caf50;
        border-color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="user-info">
          <img
            src="{{ request.cookies.get('user_avatar') or user.avatar or url_for('static', filename='images/default_avatar.png') }}"
            class="avatar"
          />
          <div class="user-details">
            <h3>{{ user.displayName }}</h3>
            <span class="coins"
              >{{ user_coins }}
              <img
                src="{{ url_for('static', filename='images/coin.png') }}"
                alt="Coins"
            /></span>
          </div>
        </div>

        <nav class="menu">
          <a href="{{ url_for('home.index') }}" class="menu-item">
            <span class="icon">üè†</span>
            <span>Trang ch·ªß</span>
          </a>
          <a href="{{ url_for('store.index') }}" class="menu-item">
            <span class="icon">üéÅ</span>
            <span>V·∫≠t ph·∫©m</span>
          </a>
          <a href="{{ url_for('profile.index') }}" class="menu-item active">
            <span class="icon">üë§</span>
            <span>H·ªì s∆°</span>
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="profile-container">
          <h1>T√†i kho·∫£n c·ªßa t√¥i</h1>

          <form
            action="{{ url_for('profile.update_profile') }}"
            method="POST"
            class="profile-form"
          >
            <div class="form-group">
              <label for="displayName">T√™n hi·ªÉn th·ªã</label>
              <input
                type="text"
                id="displayName"
                name="displayName"
                value="{{ user.displayName }}"
              />
            </div>

            <div class="form-group">
              <label for="user_id">ID</label>
              <div class="id-field">
                <input
                  type="text"
                  id="user_id"
                  value="{{ user.user_id }}"
                  readonly
                />
                <button type="button" class="copy-btn" onclick="copyUserId()">
                  üìã
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Avatar hi·ªán t·∫°i</label>
              <div class="current-avatar">
                <img
                  src="{{ request.cookies.get('user_avatar') or user.avatar or url_for('static', filename='images/default_avatar.png') }}"
                  alt="Current Avatar"
                  class="avatar-preview"
                />
              </div>
            </div>

            <div class="form-group">
              <label>Avatar ƒë√£ mua</label>
              <div class="avatar-grid">
                {# Hi·ªÉn th·ªã Avatar M·∫∑c ƒë·ªãnh t·ª´ DB (n·∫øu t·ªìn t·∫°i) #} {% if
                default_avatar_db %}
                <div
                  class="avatar-item {% if user.avatar == default_avatar_db.image_url %}active{% endif %}"
                  data-avatar-id="{{ default_avatar_db.avatar_id }}"
                >
                  <img
                    src="{{ default_avatar_db.image_url }}"
                    alt="{{ default_avatar_db.name }} (M·∫∑c ƒë·ªãnh)"
                  />
                  <input type="radio" name="selected_avatar" value="{{
                  default_avatar_db.avatar_id }}" {% if user.avatar ==
                  default_avatar_db.image_url %}checked{% endif %}>
                </div>
                {% else %} {# Fallback R·∫§T KH√îNG MONG MU·ªêN n·∫øu kh√¥ng c√≥
                default_avatar (price=0) trong DB #} {# L√∫c n√†y, ng∆∞·ªùi d√πng
                kh√¥ng th·ªÉ ch·ªçn avatar m·∫∑c ƒë·ªãnh m·ªôt c√°ch r√µ r√†ng qua ID #}
                <div
                  class="avatar-item {% if user.avatar == url_for('static', filename='images/default_avatar.png') %}active{% endif %}"
                >
                  <img
                    src="{{ url_for('static', filename='images/default_avatar.png') }}"
                    alt="Avatar M·∫∑c ƒë·ªãnh (Kh√¥ng t√¨m th·∫•y trong DB)"
                  />
                  {# Kh√¥ng c√≥ input radio ·ªü ƒë√¢y v√¨ kh√¥ng c√≥ ID ƒë√°ng tin c·∫≠y ƒë·ªÉ
                  submit #}
                </div>
                {% endif %} {# L·∫∑p qua c√°c avatar ng∆∞·ªùi d√πng ƒë√£ s·ªü h·ªØu
                (UserAvatars), tr·ª´ avatar m·∫∑c ƒë·ªãnh n·∫øu n√≥ t·ªìn t·∫°i #} {% if
                user_avatars %} {% for owned_avatar in user_avatars %} {# ƒêi·ªÅu
                ki·ªán: hi·ªÉn th·ªã n·∫øu default_avatar_db kh√¥ng t·ªìn t·∫°i HO·∫∂C n·∫øu
                owned_avatar.avatar_id kh√°c v·ªõi default_avatar_db.avatar_id #}
                {% if not default_avatar_db or (default_avatar_db and
                owned_avatar.avatar_id != default_avatar_db.avatar_id) %}
                <div
                  class="avatar-item {% if user.avatar == owned_avatar.image_url %}active{% endif %}"
                  data-avatar-id="{{ owned_avatar.avatar_id }}"
                >
                  <img
                    src="{{ owned_avatar.image_url }}"
                    alt="{{ owned_avatar.name }}"
                  />
                  <input type="radio" name="selected_avatar" value="{{
                  owned_avatar.avatar_id }}" {% if user.avatar ==
                  owned_avatar.image_url %}checked{% endif %}>
                </div>
                {% endif %} {% endfor %} {% endif %} {# Th√¥ng b√°o n·∫øu kh√¥ng c√≥
                avatar n√†o ƒë·ªÉ ch·ªçn (tr∆∞·ªùng h·ª£p user_avatars r·ªóng v√†
                default_avatar_db c≈©ng kh√¥ng c√≥) #} {# Ho·∫∑c n·∫øu user_avatars ch·ªâ
                ch·ª©a default_avatar m√† th√¥i #} {% set non_default_owned_avatars
                = [] %} {% if user_avatars and default_avatar_db %} {% for oa in
                user_avatars %} {% if oa.avatar_id !=
                default_avatar_db.avatar_id %} {% set _ =
                non_default_owned_avatars.append(oa) %} {% endif %} {% endfor %}
                {% elif user_avatars %} {% set non_default_owned_avatars =
                user_avatars %} {% endif %} {% if not default_avatar_db and not
                user_avatars %}
                <p class="no-items">
                  Kh√¥ng c√≥ avatar n√†o ƒë·ªÉ ch·ªçn. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.
                </p>
                {% elif non_default_owned_avatars|length == 0 %}
                <p class="no-items">
                  B·∫°n ch∆∞a mua th√™m avatar n√†o. H√£y ƒë·∫øn
                  <a href="{{ url_for('store.index') }}">C·ª≠a h√†ng</a> ƒë·ªÉ mua
                  avatar m·ªõi!
                </p>
                {% endif %}
              </div>
            </div>

            <button type="submit" class="btn primary-btn">C·∫≠p nh·∫≠t</button>
          </form>

          <div class="delete-account">
            <h2>X√≥a t√†i kho·∫£n</h2>
            <p>
              Vi·ªác x√≥a t√†i kho·∫£n s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n, l·ªãch s·ª≠ ƒë·∫•u, tr√≤
              ch∆°i, th·ª© h·∫°ng v√† email c·ªßa b·∫°n. Kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y.
            </p>
            <button type="button" class="btn danger-btn" id="delete-btn">
              X√≥a t√†i kho·∫£n
            </button>
          </div>
        </div>
      </div>

      <!-- User Profile Sidebar -->
      <div class="profile-sidebar">
        <div class="profile-sidebar-header">
          <a href="{{ url_for('home.index') }}" class="close-btn">&times;</a>
        </div>

        <div class="profile-user-info">
          <h3>{{ user.displayName }}</h3>
        </div>

        <div class="profile-avatar">
          <img
            src="{{ request.cookies.get('user_avatar') or user.avatar or url_for('static', filename='images/default_avatar.png') }}"
            alt="Avatar"
          />
        </div>

        <div class="profile-coins" style="text-align: center; margin-top: 10px">
          <span class="coins"
            >{{ user_coins }}
            <img
              src="{{ url_for('static', filename='images/coin.png') }}"
              alt="Coins"
          /></span>
        </div>
      </div>
    </div>

    <script>
      function copyUserId() {
        const idInput = document.getElementById("user_id");
        idInput.select();
        document.execCommand("copy");

        // Show copied notification
        alert("ID copied to clipboard!");
      }

      document
        .getElementById("delete-btn")
        .addEventListener("click", function () {
          if (
            confirm(
              "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c."
            )
          ) {
            // G·ª≠i request x√≥a t√†i kho·∫£n ƒë·∫øn server
            fetch('{{ url_for("profile.delete_account") }}', {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                // Sau khi x√≥a th√†nh c√¥ng, x√≥a cookies
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i];
                  const eqPos = cookie.indexOf("=");
                  const name =
                    eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                  document.cookie =
                    name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                }

                // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang enter_name
                window.location.href = "{{ url_for('home.enter_name') }}";
              })
              .catch((error) => {
                console.error("L·ªói khi x√≥a t√†i kho·∫£n:", error);
                alert("C√≥ l·ªói x·∫£y ra khi x√≥a t√†i kho·∫£n. Vui l√≤ng th·ª≠ l·∫°i sau.");
              });
          }
        });

      // X·ª≠ l√Ω ch·ªçn avatar
      document.addEventListener("DOMContentLoaded", function () {
        const avatarItems = document.querySelectorAll(".avatar-item");
        const radioButtons = document.querySelectorAll(
          'input[name="selected_avatar"]'
        );

        radioButtons.forEach((radio) => {
          radio.addEventListener("change", function () {
            // X√≥a class active kh·ªèi t·∫•t c·∫£ avatar
            avatarItems.forEach((item) => {
              item.classList.remove("active");
            });

            // Th√™m class active cho avatar ƒë∆∞·ª£c ch·ªçn
            if (this.checked) {
              this.closest(".avatar-item").classList.add("active");
            }
          });
        });

        // Cho ph√©p click v√†o avatar ƒë·ªÉ ch·ªçn radio button
        avatarItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            const radio = this.querySelector('input[type="radio"]');
            if (radio && e.target !== radio) {
              radio.checked = true;

              // Trigger event change ƒë·ªÉ c·∫≠p nh·∫≠t UI
              const event = new Event("change");
              radio.dispatchEvent(event);
            }
          });
        });
      });
    </script>
  </body>
</html>
