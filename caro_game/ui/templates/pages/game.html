{% extends "templates/web.html" %}

{% block title %}Trận Đấu{% endblock %}

{% block page_content %}
<div class="game-container">
    <div class="game-header">
        <div class="player-info player1">
            <div class="avatar">
                <img src="{{ player1.avatar or '/assets/caro_game/images/default-avatar.png' }}" alt="{{ player1.username }}">
                <div class="player-mark">X</div>
            </div>
            <div class="player-details">
                <div class="username">{{ player1.username }}</div>
                <div class="stats">
                    <span class="wins">{{ player1.wins }} thắng</span>
                    <span class="winrate">{{ "%.1f"|format(player1.win_rate) }}%</span>
                </div>
            </div>
        </div>

        <div class="game-status">
            <div class="timer">
                <span id="timer-value">00:00</span>
            </div>
            <div id="turn-indicator">Lượt của X</div>
            <button class="surrender-btn" onclick="surrender()">Đầu hàng</button>
        </div>

        <div class="player-info player2">
            <div class="avatar">
                <img src="{{ player2.avatar or '/assets/caro_game/images/default-avatar.png' }}" alt="{{ player2.username }}">
                <div class="player-mark">O</div>
            </div>
            <div class="player-details">
                <div class="username">{{ player2.username }}</div>
                <div class="stats">
                    <span class="wins">{{ player2.wins }} thắng</span>
                    <span class="winrate">{{ "%.1f"|format(player2.win_rate) }}%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="game-main">
        <div class="skills-panel">
            <h3>Kỹ năng</h3>
            <div class="skills-list">
                {% for skill in player_skills %}
                <div class="skill-item {{ 'active' if skill.is_active else 'disabled' }}"
                     onclick="useSkill('{{ skill.id }}')">
                    <img src="{{ skill.image_url }}" alt="{{ skill.name }}">
                    <div class="skill-tooltip">
                        <div class="skill-name">{{ skill.name }}</div>
                        <div class="skill-description">{{ skill.description }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="game-board" id="caro-board" data-game-id="{{ game.id }}">
            <!-- Board will be generated by JavaScript -->
        </div>

        <div class="chat-panel">
            <div class="chat-messages" id="chat-messages">
                {% for message in chat_messages %}
                <div class="chat-message {{ 'own-message' if message.player_id == current_player else '' }}">
                    <img src="{{ message.avatar }}" alt="{{ message.username }}" class="message-avatar">
                    <div class="message-content">
                        <span class="message-text">{{ message.text }}</span>
                        <span class="message-time">{{ message.time }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
                <button onclick="sendMessage()">Gửi</button>
            </div>
        </div>
    </div>
</div>

<!-- Game End Modal -->
<div id="gameEndModal" class="modal">
    <div class="modal-content">
        <div class="result-message">
            <h2 id="result-title"></h2>
            <div class="winner-info">
                <img id="winner-avatar" src="" alt="Winner">
                <div id="winner-name"></div>
            </div>
            <div class="game-stats">
                <div class="stat">
                    <span class="label">Thời gian</span>
                    <span id="game-time"></span>
                </div>
                <div class="stat">
                    <span class="label">Số nước đi</span>
                    <span id="move-count"></span>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button onclick="playAgain()">Chơi lại</button>
            <button onclick="returnToMenu()">Về menu</button>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
    .game-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .player-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .avatar {
        position: relative;
        width: 80px;
        height: 80px;
    }

    .avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .player-mark {
        position: absolute;
        bottom: -5px;
        right: -5px;
        width: 30px;
        height: 30px;
        background: #2196F3;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .player2 .player-mark {
        background: #FF5722;
    }

    .player-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .username {
        font-weight: bold;
        font-size: 1.2rem;
    }

    .stats {
        display: flex;
        gap: 1rem;
        color: #666;
        font-size: 0.9rem;
    }

    .game-status {
        text-align: center;
    }

    .timer {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    #turn-indicator {
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }

    .surrender-btn {
        padding: 0.8rem 1.5rem;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .game-main {
        display: flex;
        gap: 2rem;
        flex-grow: 1;
    }

    .skills-panel {
        width: 200px;
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .skills-panel h3 {
        margin-bottom: 1rem;
    }

    .skills-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .skill-item {
        position: relative;
        width: 60px;
        height: 60px;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
    }

    .skill-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .skill-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .skill-tooltip {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 0.8rem;
        border-radius: 5px;
        width: 200px;
        display: none;
        z-index: 100;
    }

    .skill-item:hover .skill-tooltip {
        display: block;
    }

    .skill-name {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .skill-description {
        font-size: 0.9rem;
    }

    .game-board {
        flex-grow: 1;
        aspect-ratio: 1;
        background: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-radius: 15px;
        display: grid;
        grid-template-columns: repeat(15, 1fr);
        grid-template-rows: repeat(15, 1fr);
        gap: 1px;
        padding: 1px;
        background: #ddd;
    }

    .board-cell {
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }

    .board-cell:hover {
        background: #f5f5f5;
    }

    .board-cell.x {
        color: #2196F3;
    }

    .board-cell.o {
        color: #FF5722;
    }

    .chat-panel {
        width: 300px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-message {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .message-content {
        background: #f5f5f5;
        padding: 0.8rem;
        border-radius: 10px;
        max-width: 80%;
    }

    .own-message {
        flex-direction: row-reverse;
    }

    .own-message .message-content {
        background: #e3f2fd;
    }

    .message-time {
        display: block;
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.3rem;
    }

    .chat-input {
        display: flex;
        padding: 1rem;
        gap: 0.5rem;
        border-top: 1px solid #eee;
    }

    .chat-input input {
        flex-grow: 1;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .chat-input button {
        padding: 0.8rem 1.5rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        text-align: center;
    }

    .winner-info {
        margin: 2rem 0;
    }

    .winner-info img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin-bottom: 1rem;
    }

    .game-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin: 2rem 0;
    }

    .stat {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 10px;
    }

    .stat .label {
        display: block;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .modal-actions button {
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    .modal-actions button:first-child {
        background: #4CAF50;
        color: white;
    }

    .modal-actions button:last-child {
        background: #f44336;
        color: white;
    }

    @media (max-width: 1200px) {
        .game-container {
            padding: 1rem;
        }

        .game-main {
            flex-direction: column;
        }

        .skills-panel {
            width: 100%;
        }

        .skills-list {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chat-panel {
            width: 100%;
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block script %}
<script>
    let gameTimer;
    let gameStartTime;
    let currentTurn = 'X';
    let gameEnded = false;

    function initGame() {
        const board = document.getElementById('caro-board');
        
        // Create board cells
        for (let i = 0; i < 15; i++) {
            for (let j = 0; j < 15; j++) {
                const cell = document.createElement('div');
                cell.className = 'board-cell';
                cell.dataset.row = i;
                cell.dataset.col = j;
                cell.addEventListener('click', () => makeMove(i, j));
                board.appendChild(cell);
            }
        }

        // Start game timer
        gameStartTime = Date.now();
        updateTimer();

        // Load initial game state
        loadGameState();
    }

    function updateTimer() {
        const elapsedTime = Math.floor((Date.now() - gameStartTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60);
        const seconds = elapsedTime % 60;
        document.getElementById('timer-value').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (!gameEnded) {
            gameTimer = requestAnimationFrame(updateTimer);
        }
    }

    function loadGameState() {
        const gameId = document.getElementById('caro-board').dataset.gameId;
        
        frappe.call({
            method: 'caro_game.game.api.get_game_state',
            args: { game_id: gameId },
            callback: function(response) {
                if (response.message) {
                    updateBoard(response.message);
                }
            }
        });
    }

    function makeMove(row, col) {
        if (gameEnded) return;

        const gameId = document.getElementById('caro-board').dataset.gameId;
        
        frappe.call({
            method: 'caro_game.game.api.make_move',
            args: {
                game_id: gameId,
                row: row,
                col: col
            },
            callback: function(response) {
                if (response.message) {
                    updateBoard(response.message);
                    
                    if (response.message.winner) {
                        endGame(response.message);
                    } else {
                        // Switch turns
                        currentTurn = currentTurn === 'X' ? 'O' : 'X';
                        document.getElementById('turn-indicator').textContent = `Lượt của ${currentTurn}`;
                    }
                }
            }
        });
    }

    function useSkill(skillId) {
        const skillItem = document.querySelector(`[onclick="useSkill('${skillId}')"]`);
        if (skillItem.classList.contains('disabled')) return;

        frappe.call({
            method: 'caro_game.game.api.use_skill',
            args: {
                game_id: document.getElementById('caro-board').dataset.gameId,
                skill_id: skillId
            },
            callback: function(response) {
                if (response.message) {
                    // Handle skill effect
                    if (response.message.effect === 'remove_last_move') {
                        loadGameState();
                    }
                    // Disable used skill
                    skillItem.classList.add('disabled');
                }
            }
        });
    }

    function updateBoard(gameState) {
        const cells = document.querySelectorAll('.board-cell');
        
        // Reset board
        cells.forEach(cell => {
            cell.textContent = '';
            cell.className = 'board-cell';
        });

        // Apply moves
        gameState.moves.forEach(move => {
            const index = move.row * 15 + move.col;
            const cell = cells[index];
            if (cell) {
                cell.textContent = move.player_mark;
                cell.classList.add(move.player_mark.toLowerCase());
            }
        });
    }

    function surrender() {
        if (confirm('Bạn có chắc chắn muốn đầu hàng?')) {
            frappe.call({
                method: 'caro_game.game.api.surrender',
                args: {
                    game_id: document.getElementById('caro-board').dataset.gameId
                },
                callback: function(response) {
                    if (response.message) {
                        endGame(response.message);
                    }
                }
            });
        }
    }

    function endGame(gameState) {
        gameEnded = true;
        cancelAnimationFrame(gameTimer);

        // Update modal content
        document.getElementById('result-title').textContent = 
            gameState.winner ? 'Chiến thắng!' : 'Trận đấu kết thúc';
        
        if (gameState.winner) {
            document.getElementById('winner-avatar').src = gameState.winner.avatar;
            document.getElementById('winner-name').textContent = gameState.winner.username;
        }

        document.getElementById('game-time').textContent = document.getElementById('timer-value').textContent;
        document.getElementById('move-count').textContent = gameState.total_moves;

        // Show modal
        document.getElementById('gameEndModal').style.display = 'block';
    }

    function playAgain() {
        const currentGameId = document.getElementById('caro-board').dataset.gameId;
        
        frappe.call({
            method: 'caro_game.game.api.rematch',
            args: { game_id: currentGameId },
            callback: function(response) {
                if (response.message) {
                    window.location.href = `/game?id=${response.message.new_game_id}`;
                }
            }
        });
    }

    function returnToMenu() {
        window.location.href = '/';
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (!message) return;

        frappe.call({
            method: 'caro_game.game.api.send_message',
            args: {
                game_id: document.getElementById('caro-board').dataset.gameId,
                message: message
            },
            callback: function(response) {
                if (response.message) {
                    appendMessage(response.message);
                    input.value = '';
                }
            }
        });
    }

    function appendMessage(message) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${message.is_own ? 'own-message' : ''}`;
        
        messageElement.innerHTML = `
            <img src="${message.avatar}" alt="${message.username}" class="message-avatar">
            <div class="message-content">
                <span class="message-text">${message.text}</span>
                <span class="message-time">${message.time}</span>
            </div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Initialize game when page loads
    document.addEventListener('DOMContentLoaded', initGame);

    // Handle chat input enter key
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('gameEndModal');
        if (event.target === modal) {
            // Don't close the modal if game has ended
            if (!gameEnded) {
                modal.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}